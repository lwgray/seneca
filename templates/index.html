<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcus Pipeline Enhancement Dashboard</title>
    <link rel="stylesheet" href="/static/css/styles.css">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    {% raw %}
    <div id="app">
        <nav class="navbar">
            <h1>Marcus Pipeline Enhancement Dashboard</h1>
            <div class="nav-tabs">
                <button @click="switchTab('monitor')" :class="{active: activeTab === 'monitor'}">
                    Live Monitor
                </button>
                <button @click="switchTab('replay')" :class="{active: activeTab === 'replay'}">
                    Pipeline Replay
                </button>
                <button @click="switchTab('whatif')" :class="{active: activeTab === 'whatif'}">
                    What-If Analysis
                </button>
                <button @click="switchTab('compare')" :class="{active: activeTab === 'compare'}">
                    Compare Flows
                </button>
                <button @click="switchTab('recommendations')" :class="{active: activeTab === 'recommendations'}">
                    Recommendations
                </button>
                <button @click="switchTab('projects')" :class="{active: activeTab === 'projects'}">
                    Project Management
                </button>
                <button @click="switchTab('agents')" :class="{active: activeTab === 'agents'}">
                    Agent Management
                </button>
                <button @click="switchTab('predictions')" :class="{active: activeTab === 'predictions'}">
                    AI Predictions
                </button>
                <button @click="switchTab('analytics')" :class="{active: activeTab === 'analytics'}">
                    Analytics & Metrics
                </button>
                <a href="/conversations" style="text-decoration: none;">
                    <button class="nav-tab">
                        Conversations
                    </button>
                </a>
            </div>
        </nav>

        <main class="container">
            <!-- Debug: Test if Vue is working -->
            <div style="background: yellow; padding: 10px; margin-bottom: 20px;">
                Vue Test - Active Tab: [[ activeTab ]] | Dashboard flows: [[ dashboard.active_flows.length ]]
            </div>
            <!-- Live Monitor Tab -->
            <div v-show="activeTab === 'monitor'" class="tab-content">
                <h2>Live Pipeline Monitor</h2>
                
                <div class="dashboard-grid">
                    <div class="metric-card">
                        <h3>Active Flows</h3>
                        <div class="metric-value">[[ dashboard.active_flows ? dashboard.active_flows.length : 0 ]]</div>
                    </div>
                    <div class="metric-card">
                        <h3>Flows/Hour</h3>
                        <div class="metric-value">[[ dashboard.system_metrics ? dashboard.system_metrics.flows_per_hour : 0 ]]</div>
                    </div>
                    <div class="metric-card">
                        <h3>Success Rate</h3>
                        <div class="metric-value">[[ dashboard.system_metrics ? dashboard.system_metrics.success_rate : 0 ]]%</div>
                    </div>
                    <div class="metric-card">
                        <h3>Avg Completion</h3>
                        <div class="metric-value">[[ dashboard.system_metrics ? Math.round(dashboard.system_metrics.avg_completion_time) : 0 ]]m</div>
                    </div>
                </div>

                <div class="flow-list">
                    <h3>Active Flows</h3>
                    <div v-for="flow in (dashboard.active_flows || [])" :key="flow.flow_id" class="flow-card">
                        <div class="flow-header">
                            <h4>[[ flow.flow_id ]]</h4>
                            <span :class="'health-badge health-' + flow.health_status.status">
                                [[ flow.health_status.status ]]
                            </span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" :style="{width: flow.progress_percentage + '%'}"></div>
                        </div>
                        <div class="flow-details">
                            <span>Stage: [[ flow.current_stage ]]</span>
                            <span v-if="flow.eta">ETA: [[ new Date(flow.eta).toLocaleTimeString() ]]</span>
                        </div>
                        <button @click="viewFlowDetails(flow.flow_id)" class="btn-secondary">
                            View Details
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pipeline Replay Tab -->
            <div v-show="activeTab === 'replay'" class="tab-content">
                <h2>Pipeline Replay</h2>
                
                <div class="replay-controls">
                    <input v-model="replayFlowId" placeholder="Enter Flow ID" class="input-field">
                    <button @click="startReplay" class="btn-primary">Start Replay</button>
                </div>

                <div v-if="replaySession" class="replay-viewer">
                    <div class="replay-timeline">
                        <input type="range" 
                               v-model="replayPosition" 
                               :max="replaySession.total_events - 1"
                               @input="jumpToPosition"
                               class="timeline-slider">
                        <div class="timeline-info">
                            Event [[ replayPosition + 1 ]] of [[ replaySession.total_events ]]
                        </div>
                    </div>

                    <div class="replay-controls-bar">
                        <button @click="stepBackward" :disabled="replayPosition === 0" class="btn-control">
                            ⏮ Previous
                        </button>
                        <button @click="playPause" class="btn-control">
                            [[ isPlaying ? '⏸ Pause' : '▶ Play' ]]
                        </button>
                        <button @click="stepForward" :disabled="replayPosition >= replaySession.total_events - 1" class="btn-control">
                            Next ⏭
                        </button>
                    </div>

                    <div class="event-viewer">
                        <h3>Current Event</h3>
                        <pre>[[ JSON.stringify(replaySession.state, null, 2) ]]</pre>
                    </div>
                </div>
            </div>

            <!-- What-If Analysis Tab -->
            <div v-show="activeTab === 'whatif'" class="tab-content">
                <h2>What-If Analysis</h2>
                
                <div class="whatif-setup">
                    <input v-model="whatifFlowId" placeholder="Enter Flow ID" class="input-field">
                    <button @click="startWhatIf" class="btn-primary">Start Analysis</button>
                </div>

                <div v-if="whatifSession" class="whatif-analyzer">
                    <div class="original-metrics">
                        <h3>Original Metrics</h3>
                        <div class="metrics-grid">
                            <div class="metric-item">
                                <label>Tasks:</label>
                                <span>[[ whatifSession.original_metrics.task_count ]]</span>
                            </div>
                            <div class="metric-item">
                                <label>Complexity:</label>
                                <span>[[ whatifSession.original_metrics.complexity ]]</span>
                            </div>
                            <div class="metric-item">
                                <label>Cost:</label>
                                <span>$[[ whatifSession.original_metrics.cost ]]</span>
                            </div>
                            <div class="metric-item">
                                <label>Quality:</label>
                                <span>[[ whatifSession.original_metrics.quality * 100 ]]%</span>
                            </div>
                        </div>
                    </div>

                    <div class="modifications">
                        <h3>Modifications</h3>
                        <div v-for="(mod, index) in modifications" :key="index" class="modification-item">
                            <select v-model="mod.parameter_type" class="select-field">
                                <option value="requirement">Requirement</option>
                                <option value="constraint">Constraint</option>
                                <option value="parameter">Parameter</option>
                            </select>
                            <input v-model="mod.parameter_name" placeholder="Parameter name" class="input-field">
                            <input v-model="mod.new_value" placeholder="New value" class="input-field">
                            <button @click="removeModification(index)" class="btn-danger">Remove</button>
                        </div>
                        <button @click="addModification" class="btn-secondary">Add Modification</button>
                        <button @click="runSimulation" class="btn-primary">Run Simulation</button>
                    </div>

                    <div v-if="simulationResults" class="simulation-results">
                        <h3>Simulation Results</h3>
                        <canvas id="whatifChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Compare Flows Tab -->
            <div v-show="activeTab === 'compare'" class="tab-content">
                <h2>Compare Pipeline Flows</h2>
                
                <div class="compare-setup">
                    <div class="flow-selector">
                        <h3>Select Flows to Compare</h3>
                        <div v-for="(flowId, index) in compareFlowIds" :key="index" class="flow-input">
                            <input v-model="compareFlowIds[index]" placeholder="Flow ID" class="input-field">
                            <button @click="removeCompareFlow(index)" class="btn-danger">Remove</button>
                        </div>
                        <button @click="addCompareFlow" class="btn-secondary">Add Flow</button>
                        <button @click="runComparison" :disabled="compareFlowIds.length < 2" class="btn-primary">
                            Compare Flows
                        </button>
                    </div>
                </div>

                <div v-if="comparisonReport" class="comparison-results">
                    <div class="comparison-summary">
                        <h3>Flow Summaries</h3>
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Duration</th>
                                    <th>Cost</th>
                                    <th>Tasks</th>
                                    <th>Quality</th>
                                    <th>Complexity</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="flow in comparisonReport.flow_summaries" :key="flow.flow_id">
                                    <td>[[ flow.project_name ]]</td>
                                    <td>[[ flow.duration_seconds ]]s</td>
                                    <td>$[[ flow.cost ]]</td>
                                    <td>[[ flow.task_count ]]</td>
                                    <td>[[ Math.round(flow.quality_score * 100) ]]%</td>
                                    <td>[[ flow.complexity.toFixed(2) ]]</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="comparison-charts">
                        <canvas id="comparisonChart"></canvas>
                    </div>

                    <div class="comparison-recommendations">
                        <h3>Recommendations</h3>
                        <ul>
                            <li v-for="rec in comparisonReport.recommendations" :key="rec">
                                [[ rec ]]
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Recommendations Tab -->
            <div v-show="activeTab === 'recommendations'" class="tab-content">
                <h2>Pipeline Recommendations</h2>
                
                <div class="recommendations-setup">
                    <input v-model="recommendFlowId" placeholder="Enter Flow ID" class="input-field">
                    <button @click="getRecommendations" class="btn-primary">Get Recommendations</button>
                </div>

                <div v-if="recommendations" class="recommendations-list">
                    <div v-for="rec in recommendations" :key="rec.type" class="recommendation-card">
                        <div class="rec-header">
                            <h3>[[ rec.message ]]</h3>
                            <span class="confidence-badge">[[ Math.round(rec.confidence * 100) ]]% confident</span>
                        </div>
                        <p class="rec-impact">Impact: [[ rec.impact ]]</p>
                        <div v-if="rec.supporting_data" class="rec-details">
                            <h4>Supporting Data:</h4>
                            <pre>[[ JSON.stringify(rec.supporting_data, null, 2) ]]</pre>
                        </div>
                    </div>
                </div>

                <div v-if="similarFlows" class="similar-flows">
                    <h3>Similar Flows</h3>
                    <div v-for="flow in similarFlows" :key="flow.flow_id" class="similar-flow-item">
                        <span>[[ flow.project_name ]]</span>
                        <span class="similarity">[[ Math.round(flow.similarity * 100) ]]% similar</span>
                        <button @click="viewFlow(flow.flow_id)" class="btn-secondary">View</button>
                    </div>
                </div>
            </div>

            <!-- Project Management Tab -->
            <div v-show="activeTab === 'projects'" class="tab-content">
                <h2>Project Management</h2>
                
                <div class="project-creation">
                    <h3>Create New Project</h3>
                    
                    <!-- Sample Projects Dropdown -->
                    <div class="sample-selector">
                        <label>Quick Start with Sample Project:</label>
                        <select v-model="selectedSample" @change="loadSampleProject" class="select-field">
                            <option value="">-- Select a sample project --</option>
                            <option v-for="sample in sampleProjects" :key="sample.id" :value="sample.id">
                                [[ sample.name ]]
                            </option>
                        </select>
                    </div>
                    
                    <div class="divider">OR</div>
                    
                    <!-- Custom Project Form -->
                    <div class="project-form">
                        <input v-model="newProject.name" placeholder="Project Name" class="input-field">
                        <textarea v-model="newProject.description" 
                                  placeholder="Describe your project in natural language. Marcus will analyze and create tasks automatically." 
                                  class="textarea-field"
                                  rows="6"></textarea>
                        <button @click="createProject" :disabled="!newProject.description" class="btn-primary">
                            Create Project with AI Analysis
                        </button>
                    </div>
                </div>

                <div v-if="currentProject" class="current-project">
                    <h3>Current Project: [[ currentProject.name ]]</h3>
                    <div class="project-info">
                        <p><strong>Status:</strong> [[ currentProject.status ]]</p>
                        <p><strong>Created:</strong> [[ new Date(currentProject.created_at).toLocaleString() ]]</p>
                        <p v-if="currentProject.task_count"><strong>Tasks Generated:</strong> [[ currentProject.task_count ]]</p>
                        <p v-if="currentProject.estimated_hours"><strong>Estimated Hours:</strong> [[ currentProject.estimated_hours ]]</p>
                        <!-- Cost Information -->
                        <div v-if="currentProject.tokenCosts" class="cost-section">
                            <h4>Real-Time Cost Tracking</h4>
                            <div class="cost-metrics">
                                <div class="metric-row">
                                    <span class="metric-label">Total Tokens Used:</span>
                                    <span class="metric-value">[[ currentProject.tokenCosts.total_tokens.toLocaleString() ]]</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Actual Cost (Tokens):</span>
                                    <span class="metric-value cost-actual">$[[ currentProject.tokenCosts.total_cost ]]</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Current Burn Rate:</span>
                                    <span class="metric-value">[[ currentProject.tokenCosts.current_spend_rate.toLocaleString() ]] tokens/hr</span>
                                </div>
                                <div class="metric-row">
                                    <span class="metric-label">Cost per Hour:</span>
                                    <span class="metric-value">$[[ currentProject.tokenCosts.cost_per_hour ]]/hr</span>
                                </div>
                                <div class="metric-row" v-if="currentProject.tokenCosts.projected_cost > 0">
                                    <span class="metric-label">Projected Total Cost:</span>
                                    <span class="metric-value cost-projected">$[[ currentProject.tokenCosts.projected_cost ]]</span>
                                </div>
                                <div class="metric-row" v-if="currentProject.naive_cost">
                                    <span class="metric-label">Naive Estimate ($150/hr):</span>
                                    <span class="metric-value cost-naive">$[[ currentProject.naive_cost ]]</span>
                                </div>
                                <div class="metric-row" v-if="currentProject.costComparison">
                                    <span class="metric-label">Variance:</span>
                                    <span class="metric-value" :class="currentProject.costComparison.direction === 'over' ? 'cost-over' : 'cost-under'">
                                        [[ currentProject.costComparison.percentage ]]% [[ currentProject.costComparison.direction ]]
                                    </span>
                                </div>
                            </div>
                        </div>
                        <!-- Fallback to naive estimate if no token tracking -->
                        <p v-else-if="currentProject.estimated_cost"><strong>Estimated Cost (Naive):</strong> $[[ currentProject.estimated_cost ]]</p>
                    </div>

                    <div v-if="currentProject.prd_analysis" class="prd-analysis">
                        <h4>AI Analysis Results</h4>
                        <div class="analysis-section" v-if="currentProject.prd_analysis.features">
                            <h5>Identified Features:</h5>
                            <ul>
                                <li v-for="feature in currentProject.prd_analysis.features" :key="feature">
                                    [[ feature ]]
                                </li>
                            </ul>
                        </div>
                        <div class="analysis-section" v-if="currentProject.prd_analysis.tech_stack">
                            <h5>Recommended Tech Stack:</h5>
                            <p>[[ currentProject.prd_analysis.tech_stack ]]</p>
                        </div>
                        <div class="analysis-section" v-if="currentProject.prd_analysis.complexity">
                            <h5>Project Complexity:</h5>
                            <p>[[ currentProject.prd_analysis.complexity ]]</p>
                        </div>
                    </div>

                    <div class="workflow-controls">
                        <h4>Workflow Management</h4>
                        <div class="workflow-options">
                            <div class="option-group">
                                <label>
                                    <input type="checkbox" v-model="workflowOptions.auto_assign">
                                    Auto-assign tasks to available agents
                                </label>
                            </div>
                            <div class="option-group">
                                <label>
                                    <input type="checkbox" v-model="workflowOptions.parallel_execution">
                                    Enable parallel task execution
                                </label>
                            </div>
                            <div class="option-group">
                                <label>
                                    <input type="checkbox" v-model="workflowOptions.continuous_monitoring">
                                    Enable continuous monitoring
                                </label>
                            </div>
                            <div class="option-group">
                                <label>Max Agents:</label>
                                <input type="number" v-model.number="workflowOptions.max_agents" 
                                       min="1" max="10" class="input-field input-small">
                            </div>
                        </div>
                        
                        <div class="workflow-actions">
                            <button @click="startWorkflow" 
                                    :disabled="!currentProject || currentProject.status === 'running'"
                                    class="btn-primary btn-large">
                                Start Workflow
                            </button>
                            <button @click="pauseWorkflow" 
                                    :disabled="currentProject?.status !== 'running'"
                                    class="btn-warning">
                                Pause Workflow
                            </button>
                            <button @click="stopWorkflow" 
                                    :disabled="currentProject?.status !== 'running' && currentProject?.status !== 'paused'"
                                    class="btn-danger">
                                Stop Workflow
                            </button>
                        </div>
                    </div>
                </div>

                <div class="existing-projects">
                    <h3>Existing Projects</h3>
                    <button @click="refreshProjects" class="btn-secondary">Refresh</button>
                    
                    <div class="projects-grid">
                        <div v-for="project in existingProjects" :key="project.id" class="project-card">
                            <div class="project-header">
                                <h4>[[ project.name ]]</h4>
                                <span :class="'status-badge status-' + project.status">
                                    [[ project.status ]]
                                </span>
                            </div>
                            <p>[[ project.description ]]</p>
                            <div class="project-stats">
                                <span>Features: [[ project.feature_count ]]</span>
                                <span>Tasks: [[ project.task_count ]]</span>
                                <span>Progress: [[ project.progress ]]%</span>
                            </div>
                            <div class="project-actions">
                                <button @click="selectProject(project.id)" class="btn-primary">
                                    Select
                                </button>
                                <button @click="viewProjectFlow(project.id)" class="btn-secondary">
                                    View Flow
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agent Management Tab -->
            <div v-show="activeTab === 'agents'" class="tab-content">
                <h2>Agent Management</h2>
                
                <div class="agent-controls">
                    <h3>Register New Agent</h3>
                    <div class="agent-form">
                        <input v-model="newAgent.id" placeholder="Agent ID (e.g., agent-001)" class="input-field">
                        <input v-model="newAgent.name" placeholder="Agent Name" class="input-field">
                        <select v-model="newAgent.role" class="select-field">
                            <option value="">Select Role</option>
                            <option value="Backend Developer">Backend Developer</option>
                            <option value="Frontend Developer">Frontend Developer</option>
                            <option value="Full Stack Developer">Full Stack Developer</option>
                            <option value="DevOps Engineer">DevOps Engineer</option>
                            <option value="QA Engineer">QA Engineer</option>
                        </select>
                        <button @click="registerAgent" class="btn-primary">Register Agent</button>
                    </div>
                </div>

                <div class="registered-agents">
                    <h3>Registered Agents</h3>
                    <button @click="refreshAgents" class="btn-secondary">Refresh</button>
                    
                    <div class="agents-grid">
                        <div v-for="agent in registeredAgents" :key="agent.agent_id" class="agent-card">
                            <div class="agent-header">
                                <h4>[[ agent.name ]]</h4>
                                <span :class="'status-badge status-' + agent.status">
                                    [[ agent.status ]]
                                </span>
                            </div>
                            <div class="agent-details">
                                <p><strong>ID:</strong> [[ agent.agent_id ]]</p>
                                <p><strong>Role:</strong> [[ agent.role ]]</p>
                                <p v-if="agent.current_task"><strong>Current Task:</strong> [[ agent.current_task.name ]]</p>
                            </div>
                            <div class="agent-actions">
                                <button @click="requestTaskForAgent(agent.agent_id)" 
                                        :disabled="agent.status !== 'idle'"
                                        class="btn-primary">
                                    Request Task
                                </button>
                                <button @click="getAgentStatus(agent.agent_id)" class="btn-secondary">
                                    Get Status
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="task-simulation">
                    <h3>Task Progress Simulation</h3>
                    <div class="simulation-form">
                        <select v-model="taskUpdate.agent_id" class="select-field">
                            <option value="">Select Agent</option>
                            <option v-for="agent in registeredAgents" 
                                    :value="agent.agent_id"
                                    :key="agent.agent_id">
                                [[ agent.name ]] ([[ agent.agent_id ]])
                            </option>
                        </select>
                        <input v-model="taskUpdate.task_id" placeholder="Task ID" class="input-field">
                        <select v-model="taskUpdate.status" class="select-field">
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="blocked">Blocked</option>
                        </select>
                        <input v-model.number="taskUpdate.progress" 
                               type="number" 
                               min="0" 
                               max="100" 
                               placeholder="Progress %" 
                               class="input-field">
                        <textarea v-model="taskUpdate.message" 
                                  placeholder="Progress message" 
                                  class="textarea-field"></textarea>
                        <button @click="reportProgress" class="btn-primary">Report Progress</button>
                    </div>
                </div>

                <div class="project-overview">
                    <h3>Project Status</h3>
                    <button @click="getProjectStatus" class="btn-primary">Get Current Status</button>
                    
                    <div v-if="projectStatus" class="project-status">
                        <div class="status-grid">
                            <div class="status-item">
                                <label>Total Tasks:</label>
                                <span>[[ projectStatus.total_tasks ]]</span>
                            </div>
                            <div class="status-item">
                                <label>Completed:</label>
                                <span>[[ projectStatus.completed_tasks ]]</span>
                            </div>
                            <div class="status-item">
                                <label>In Progress:</label>
                                <span>[[ projectStatus.in_progress_tasks ]]</span>
                            </div>
                            <div class="status-item">
                                <label>Blocked:</label>
                                <span>[[ projectStatus.blocked_tasks ]]</span>
                            </div>
                            <div class="status-item">
                                <label>Progress:</label>
                                <span>[[ projectStatus.progress_percent ]]%</span>
                            </div>
                            <div class="status-item">
                                <label>Active Agents:</label>
                                <span>[[ projectStatus.active_agents ]]</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="agent-logs">
                    <h3>Agent Activity Log</h3>
                    <div class="log-entries">
                        <div v-for="log in agentLogs" :key="log.timestamp" class="log-entry">
                            <span class="log-time">[[ new Date(log.timestamp).toLocaleTimeString() ]]</span>
                            <span class="log-agent">[[ log.agent_id ]]:</span>
                            <span class="log-message">[[ log.message ]]</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Predictions Tab -->
            <div v-show="activeTab === 'predictions'" class="tab-content">
                <h2>Marcus AI Predictions</h2>
                
                <!-- Project Completion Predictions -->
                <div class="prediction-section">
                    <h3>Project Completion Predictions</h3>
                    <div class="prediction-form">
                        <input v-model="predictionForm.projectId" 
                               placeholder="Project ID" 
                               class="input-field">
                        <label>
                            <input type="checkbox" v-model="predictionForm.includeConfidence">
                            Include confidence intervals
                        </label>
                        <button @click="predictProjectCompletion" class="btn-primary">
                            Predict Completion
                        </button>
                    </div>
                    
                    <div v-if="predictions.projectCompletion" class="prediction-results">
                        <div class="prediction-card">
                            <h4>Project Completion Forecast</h4>
                            <div v-if="predictions.projectCompletion.data" class="prediction-content">
                                <div class="metric-grid">
                                    <div class="metric-item">
                                        <label>Estimated Completion:</label>
                                        <span class="completion-date">
                                            [[ predictions.projectCompletion.data.estimated_completion_date || 'Not available' ]]
                                        </span>
                                    </div>
                                    <div class="metric-item" v-if="predictions.projectCompletion.data.velocity">
                                        <label>Current Velocity:</label>
                                        <span>[[ predictions.projectCompletion.data.velocity ]] tasks/day</span>
                                    </div>
                                    <div class="metric-item" v-if="predictions.projectCompletion.data.confidence_score">
                                        <label>Confidence:</label>
                                        <span class="confidence-score">
                                            [[ Math.round(predictions.projectCompletion.data.confidence_score * 100) ]]%
                                        </span>
                                    </div>
                                </div>
                                
                                <div v-if="predictions.projectCompletion.data.risk_factors" class="risk-factors">
                                    <h5>Risk Factors:</h5>
                                    <ul>
                                        <li v-for="risk in predictions.projectCompletion.data.risk_factors" :key="risk">
                                            [[ risk ]]
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task Outcome Predictions -->
                <div class="prediction-section">
                    <h3>Task Outcome Predictions</h3>
                    <div class="prediction-form">
                        <input v-model="predictionForm.taskId" 
                               placeholder="Task ID" 
                               class="input-field">
                        <input v-model="predictionForm.agentId" 
                               placeholder="Agent ID (optional)" 
                               class="input-field">
                        <button @click="predictTaskOutcome" class="btn-primary">
                            Predict Outcome
                        </button>
                    </div>
                    
                    <div v-if="predictions.taskOutcome" class="prediction-results">
                        <div class="prediction-card">
                            <h4>Task Success Prediction</h4>
                            <div v-if="predictions.taskOutcome.data" class="prediction-content">
                                <div class="success-probability">
                                    <div class="probability-meter">
                                        <div class="probability-fill" 
                                             :style="{width: (predictions.taskOutcome.data.success_probability || 0) * 100 + '%'}">
                                        </div>
                                    </div>
                                    <span class="probability-text">
                                        [[ Math.round((predictions.taskOutcome.data.success_probability || 0) * 100) ]]% Success Probability
                                    </span>
                                </div>
                                
                                <div class="outcome-metrics">
                                    <div class="metric-item" v-if="predictions.taskOutcome.data.estimated_duration">
                                        <label>Estimated Duration:</label>
                                        <span>[[ predictions.taskOutcome.data.estimated_duration ]] hours</span>
                                    </div>
                                    <div class="metric-item" v-if="predictions.taskOutcome.data.blockage_risk">
                                        <label>Blockage Risk:</label>
                                        <span :class="getBlockageRiskClass(predictions.taskOutcome.data.blockage_risk)">
                                            [[ Math.round(predictions.taskOutcome.data.blockage_risk * 100) ]]%
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Blockage Risk Analysis -->
                <div class="prediction-section">
                    <h3>Blockage Risk Analysis</h3>
                    <div class="prediction-form">
                        <input v-model="predictionForm.blockageTaskId" 
                               placeholder="Task ID" 
                               class="input-field">
                        <label>
                            <input type="checkbox" v-model="predictionForm.includeMitigation">
                            Include mitigation suggestions
                        </label>
                        <button @click="predictBlockageRisk" class="btn-primary">
                            Analyze Blockage Risk
                        </button>
                    </div>
                    
                    <div v-if="predictions.blockageRisk" class="prediction-results">
                        <div class="prediction-card">
                            <h4>Blockage Risk Assessment</h4>
                            <div v-if="predictions.blockageRisk.data" class="prediction-content">
                                <div class="risk-meter">
                                    <div class="risk-level" 
                                         :class="getBlockageRiskClass(predictions.blockageRisk.data.blockage_probability)">
                                        [[ Math.round((predictions.blockageRisk.data.blockage_probability || 0) * 100) ]]%
                                        Risk of Blockage
                                    </div>
                                </div>
                                
                                <div v-if="predictions.blockageRisk.data.likely_causes" class="likely-causes">
                                    <h5>Likely Causes:</h5>
                                    <ul>
                                        <li v-for="cause in predictions.blockageRisk.data.likely_causes" :key="cause">
                                            [[ cause ]]
                                        </li>
                                    </ul>
                                </div>
                                
                                <div v-if="predictions.blockageRisk.data.mitigation_suggestions" class="mitigation-suggestions">
                                    <h5>Suggested Mitigations:</h5>
                                    <ul>
                                        <li v-for="suggestion in predictions.blockageRisk.data.mitigation_suggestions" :key="suggestion">
                                            [[ suggestion ]]
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cascade Effects Analysis -->
                <div class="prediction-section">
                    <h3>Cascade Effects Analysis</h3>
                    <div class="prediction-form">
                        <input v-model="predictionForm.cascadeTaskId" 
                               placeholder="Task ID" 
                               class="input-field">
                        <input v-model.number="predictionForm.delayDays" 
                               type="number" 
                               min="1" 
                               max="30"
                               placeholder="Days of delay to simulate" 
                               class="input-field">
                        <button @click="predictCascadeEffects" class="btn-primary">
                            Analyze Cascade Effects
                        </button>
                    </div>
                    
                    <div v-if="predictions.cascadeEffects" class="prediction-results">
                        <div class="prediction-card">
                            <h4>Cascade Impact Analysis</h4>
                            <div v-if="predictions.cascadeEffects.data" class="prediction-content">
                                <div class="impact-summary">
                                    <div class="metric-item" v-if="predictions.cascadeEffects.data.affected_tasks_count">
                                        <label>Affected Tasks:</label>
                                        <span class="impact-number">[[ predictions.cascadeEffects.data.affected_tasks_count ]]</span>
                                    </div>
                                    <div class="metric-item" v-if="predictions.cascadeEffects.data.total_delay_impact">
                                        <label>Total Delay Impact:</label>
                                        <span class="impact-number">[[ predictions.cascadeEffects.data.total_delay_impact ]] days</span>
                                    </div>
                                </div>
                                
                                <div v-if="predictions.cascadeEffects.data.affected_tasks" class="affected-tasks">
                                    <h5>Affected Tasks:</h5>
                                    <div class="task-list">
                                        <div v-for="task in predictions.cascadeEffects.data.affected_tasks" 
                                             :key="task.task_id" 
                                             class="affected-task">
                                            <span class="task-id">[[ task.task_id ]]</span>
                                            <span class="task-delay">+[[ task.additional_delay ]] days</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Task Assignment Scoring -->
                <div class="prediction-section">
                    <h3>Task Assignment Scoring</h3>
                    <div class="prediction-form">
                        <input v-model="predictionForm.assignmentTaskId" 
                               placeholder="Task ID" 
                               class="input-field">
                        <input v-model="predictionForm.assignmentAgentId" 
                               placeholder="Agent ID" 
                               class="input-field">
                        <button @click="getAssignmentScore" class="btn-primary">
                            Score Assignment
                        </button>
                    </div>
                    
                    <div v-if="predictions.assignmentScore" class="prediction-results">
                        <div class="prediction-card">
                            <h4>Assignment Fitness Score</h4>
                            <div v-if="predictions.assignmentScore.data" class="prediction-content">
                                <div class="assignment-score">
                                    <div class="score-circle" :class="getScoreClass(predictions.assignmentScore.data.overall_score)">
                                        <span class="score-number">
                                            [[ Math.round((predictions.assignmentScore.data.overall_score || 0) * 100) ]]
                                        </span>
                                        <span class="score-label">Score</span>
                                    </div>
                                </div>
                                
                                <div class="score-breakdown">
                                    <div class="breakdown-item" v-if="predictions.assignmentScore.data.skill_match">
                                        <label>Skill Match:</label>
                                        <div class="score-bar">
                                            <div class="score-fill" 
                                                 :style="{width: predictions.assignmentScore.data.skill_match * 100 + '%'}">
                                            </div>
                                        </div>
                                        <span>[[ Math.round(predictions.assignmentScore.data.skill_match * 100) ]]%</span>
                                    </div>
                                    
                                    <div class="breakdown-item" v-if="predictions.assignmentScore.data.availability">
                                        <label>Availability:</label>
                                        <div class="score-bar">
                                            <div class="score-fill" 
                                                 :style="{width: predictions.assignmentScore.data.availability * 100 + '%'}">
                                            </div>
                                        </div>
                                        <span>[[ Math.round(predictions.assignmentScore.data.availability * 100) ]]%</span>
                                    </div>
                                </div>
                                
                                <div v-if="predictions.assignmentScore.data.recommendation" class="assignment-recommendation">
                                    <h5>Recommendation:</h5>
                                    <p class="recommendation-text">
                                        [[ predictions.assignmentScore.data.recommendation ]]
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics & Metrics Tab -->
            <div v-show="activeTab === 'analytics'" class="tab-content">
                <h2>Analytics & Code Metrics Dashboard</h2>
                
                <!-- Dashboard Overview -->
                <div class="analytics-section">
                    <h3>System Overview</h3>
                    <div class="analytics-controls">
                        <select v-model="analyticsForm.timeWindow" class="select-field">
                            <option value="1h">Last Hour</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                        </select>
                        <button @click="loadDashboardOverview" class="btn-primary">
                            Load Overview
                        </button>
                    </div>
                    
                    <div v-if="analytics.dashboardOverview" class="overview-grid">
                        <!-- System Metrics -->
                        <div v-if="analytics.dashboardOverview.data.system_metrics" class="metrics-card">
                            <h4>System Health</h4>
                            <div class="system-stats">
                                <div class="stat-item">
                                    <label>Active Agents:</label>
                                    <span class="stat-value">
                                        [[ analytics.dashboardOverview.data.system_metrics.active_agents || 0 ]]
                                    </span>
                                </div>
                                <div class="stat-item">
                                    <label>Throughput:</label>
                                    <span class="stat-value">
                                        [[ analytics.dashboardOverview.data.system_metrics.throughput || 0 ]] tasks/hr
                                    </span>
                                </div>
                                <div class="stat-item">
                                    <label>Health Score:</label>
                                    <span class="stat-value" :class="getHealthScoreClass(analytics.dashboardOverview.data.system_metrics.health_score)">
                                        [[ Math.round((analytics.dashboardOverview.data.system_metrics.health_score || 0) * 100) ]]%
                                    </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Task Breakdown -->
                        <div v-if="analytics.dashboardOverview.data.task_breakdown" class="metrics-card">
                            <h4>Task Status</h4>
                            <div class="task-chart">
                                <canvas id="taskBreakdownChart" width="300" height="200"></canvas>
                            </div>
                        </div>
                        
                        <!-- Project Metrics -->
                        <div v-if="analytics.dashboardOverview.data.project_metrics" class="metrics-card">
                            <h4>Project Progress</h4>
                            <div class="project-stats">
                                <div class="stat-item">
                                    <label>Progress:</label>
                                    <div class="progress-bar">
                                        <div class="progress-fill" 
                                             :style="{width: (analytics.dashboardOverview.data.project_metrics.progress_percentage || 0) + '%'}">
                                        </div>
                                    </div>
                                    <span>[[ analytics.dashboardOverview.data.project_metrics.progress_percentage || 0 ]]%</span>
                                </div>
                                <div class="stat-item">
                                    <label>Velocity:</label>
                                    <span class="stat-value">
                                        [[ analytics.dashboardOverview.data.project_metrics.velocity || 0 ]] tasks/day
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Agent Performance -->
                <div class="analytics-section">
                    <h3>Agent Performance</h3>
                    <div class="analytics-controls">
                        <input v-model="analyticsForm.agentId" 
                               placeholder="Agent ID" 
                               class="input-field">
                        <select v-model="analyticsForm.agentTimeWindow" class="select-field">
                            <option value="1h">Last Hour</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                        </select>
                        <button @click="loadAgentMetrics" class="btn-primary">
                            Get Agent Metrics
                        </button>
                    </div>
                    
                    <div v-if="analytics.agentMetrics" class="agent-metrics-display">
                        <div class="metrics-grid">
                            <!-- Agent Utilization -->
                            <div class="metric-card">
                                <h5>Utilization</h5>
                                <div class="utilization-circle" 
                                     :class="getUtilizationClass(analytics.agentMetrics.data.utilization_percentage)">
                                    <span class="util-number">
                                        [[ Math.round(analytics.agentMetrics.data.utilization_percentage || 0) ]]%
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Tasks Completed -->
                            <div class="metric-card">
                                <h5>Tasks Completed</h5>
                                <div class="metric-large">
                                    [[ analytics.agentMetrics.data.tasks_completed || 0 ]]
                                </div>
                            </div>
                            
                            <!-- Success Rate -->
                            <div class="metric-card">
                                <h5>Success Rate</h5>
                                <div class="success-meter">
                                    <div class="success-fill" 
                                         :style="{width: (analytics.agentMetrics.data.success_rate || 0) * 100 + '%'}">
                                    </div>
                                </div>
                                <span>[[ Math.round((analytics.agentMetrics.data.success_rate || 0) * 100) ]]%</span>
                            </div>
                            
                            <!-- Average Task Time -->
                            <div class="metric-card">
                                <h5>Avg Task Time</h5>
                                <div class="metric-large">
                                    [[ analytics.agentMetrics.data.average_task_time || 0 ]]h
                                </div>
                            </div>
                        </div>
                        
                        <!-- Skill Distribution -->
                        <div v-if="analytics.agentMetrics.data.skill_distribution" class="skill-distribution">
                            <h5>Skill Distribution</h5>
                            <div class="skills-list">
                                <div v-for="(count, skill) in analytics.agentMetrics.data.skill_distribution" 
                                     :key="skill" 
                                     class="skill-item">
                                    <span class="skill-name">[[ skill ]]</span>
                                    <div class="skill-bar">
                                        <div class="skill-fill" 
                                             :style="{width: (count / Math.max(...Object.values(analytics.agentMetrics.data.skill_distribution)) * 100) + '%'}">
                                        </div>
                                    </div>
                                    <span class="skill-count">[[ count ]]</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Code Metrics -->
                <div class="analytics-section">
                    <h3>Code Production Metrics</h3>
                    <div class="analytics-controls">
                        <input v-model="analyticsForm.codeAgentId" 
                               placeholder="Agent ID" 
                               class="input-field">
                        <input v-model="analyticsForm.startDate" 
                               type="date" 
                               class="input-field">
                        <input v-model="analyticsForm.endDate" 
                               type="date" 
                               class="input-field">
                        <button @click="loadCodeMetrics" class="btn-primary">
                            Get Code Metrics
                        </button>
                    </div>
                    
                    <div v-if="analytics.codeMetrics" class="code-metrics-display">
                        <div class="code-stats-grid">
                            <!-- Commits -->
                            <div class="code-stat-card">
                                <div class="stat-icon">📝</div>
                                <div class="stat-content">
                                    <h5>Commits</h5>
                                    <div class="stat-number">[[ analytics.codeMetrics.data.total_commits || 0 ]]</div>
                                </div>
                            </div>
                            
                            <!-- Lines Added -->
                            <div class="code-stat-card">
                                <div class="stat-icon">➕</div>
                                <div class="stat-content">
                                    <h5>Lines Added</h5>
                                    <div class="stat-number positive">[[ analytics.codeMetrics.data.lines_added || 0 ]]</div>
                                </div>
                            </div>
                            
                            <!-- Lines Deleted -->
                            <div class="code-stat-card">
                                <div class="stat-icon">➖</div>
                                <div class="stat-content">
                                    <h5>Lines Deleted</h5>
                                    <div class="stat-number negative">[[ analytics.codeMetrics.data.lines_deleted || 0 ]]</div>
                                </div>
                            </div>
                            
                            <!-- Files Changed -->
                            <div class="code-stat-card">
                                <div class="stat-icon">📁</div>
                                <div class="stat-content">
                                    <h5>Files Changed</h5>
                                    <div class="stat-number">[[ analytics.codeMetrics.data.files_changed || 0 ]]</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Language Distribution -->
                        <div v-if="analytics.codeMetrics.data.language_distribution" class="language-distribution">
                            <h5>Language Distribution</h5>
                            <div class="languages-grid">
                                <div v-for="(percentage, language) in analytics.codeMetrics.data.language_distribution" 
                                     :key="language" 
                                     class="language-item">
                                    <div class="language-circle" :style="{background: getLanguageColor(language)}">
                                        <span class="lang-abbr">[[ language.substring(0, 2).toUpperCase() ]]</span>
                                    </div>
                                    <div class="language-info">
                                        <span class="language-name">[[ language ]]</span>
                                        <span class="language-percent">[[ Math.round(percentage) ]]%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Repository Analytics -->
                <div class="analytics-section">
                    <h3>Repository Analytics</h3>
                    <div class="analytics-controls">
                        <input v-model="analyticsForm.repository" 
                               placeholder="Repository name" 
                               class="input-field">
                        <select v-model="analyticsForm.repoTimeWindow" class="select-field">
                            <option value="1h">Last Hour</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d">Last 30 Days</option>
                        </select>
                        <button @click="loadRepositoryMetrics" class="btn-primary">
                            Get Repository Metrics
                        </button>
                    </div>
                    
                    <div v-if="analytics.repositoryMetrics" class="repo-metrics-display">
                        <div class="repo-overview">
                            <div class="repo-stat">
                                <label>Commit Frequency:</label>
                                <span>[[ analytics.repositoryMetrics.data.commit_frequency || 0 ]] commits/day</span>
                            </div>
                            <div class="repo-stat">
                                <label>Active Contributors:</label>
                                <span>[[ analytics.repositoryMetrics.data.active_contributors || 0 ]]</span>
                            </div>
                            <div class="repo-stat">
                                <label>PR Merge Rate:</label>
                                <span>[[ Math.round((analytics.repositoryMetrics.data.pr_merge_rate || 0) * 100) ]]%</span>
                            </div>
                        </div>
                        
                        <!-- Repository Language Breakdown -->
                        <div v-if="analytics.repositoryMetrics.data.language_breakdown" class="repo-languages">
                            <h5>Repository Languages</h5>
                            <canvas id="repoLanguageChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Code Quality -->
                <div class="analytics-section">
                    <h3>Code Quality Metrics</h3>
                    <div class="analytics-controls">
                        <input v-model="analyticsForm.qualityRepository" 
                               placeholder="Repository name" 
                               class="input-field">
                        <input v-model="analyticsForm.branch" 
                               placeholder="Branch (default: main)" 
                               class="input-field">
                        <button @click="loadCodeQualityMetrics" class="btn-primary">
                            Get Quality Metrics
                        </button>
                    </div>
                    
                    <div v-if="analytics.codeQuality" class="quality-metrics-display">
                        <div class="quality-grid">
                            <!-- Coverage -->
                            <div class="quality-card">
                                <h5>Test Coverage</h5>
                                <div class="coverage-circle" :class="getCoverageClass(analytics.codeQuality.data.test_coverage)">
                                    <span class="coverage-percent">
                                        [[ Math.round((analytics.codeQuality.data.test_coverage || 0) * 100) ]]%
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Complexity -->
                            <div class="quality-card">
                                <h5>Complexity Score</h5>
                                <div class="complexity-meter">
                                    <div class="complexity-level" 
                                         :class="getComplexityClass(analytics.codeQuality.data.complexity_score)">
                                        [[ analytics.codeQuality.data.complexity_score || 0 ]]
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Technical Debt -->
                            <div class="quality-card">
                                <h5>Technical Debt</h5>
                                <div class="debt-indicator" 
                                     :class="getDebtClass(analytics.codeQuality.data.technical_debt_hours)">
                                    [[ analytics.codeQuality.data.technical_debt_hours || 0 ]]h
                                </div>
                            </div>
                            
                            <!-- Security Issues -->
                            <div class="quality-card">
                                <h5>Security Issues</h5>
                                <div class="security-count" 
                                     :class="getSecurityClass(analytics.codeQuality.data.security_issues)">
                                    [[ analytics.codeQuality.data.security_issues || 0 ]]
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quality Gate Status -->
                        <div class="quality-gate">
                            <h5>Quality Gate Status</h5>
                            <div class="gate-status" 
                                 :class="analytics.codeQuality.data.quality_gate_passed ? 'gate-passed' : 'gate-failed'">
                                [[ analytics.codeQuality.data.quality_gate_passed ? '✅ PASSED' : '❌ FAILED' ]]
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    {% endraw %}
    <script src="/static/js/app.js"></script>
</body>
</html>